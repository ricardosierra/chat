{"version":3,"file":"base.js","sourceRoot":"","sources":["../../src/transports/base.ts"],"names":[],"mappings":"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","sourcesContent":["import { API, PromiseBuffer, SentryError } from '@sentry/core';\nimport { SentryResponse, Status, Transport, TransportOptions } from '@sentry/types';\nimport * as fs from 'fs';\nimport * as http from 'http';\nimport * as https from 'https';\nimport * as url from 'url';\nimport { SDK_NAME, SDK_VERSION } from '../version';\n\n/** Internal used interface for typescript */\nexport interface HTTPRequest {\n  request(\n    options: http.RequestOptions | https.RequestOptions | string | url.URL,\n    callback?: (res: http.IncomingMessage) => void,\n  ): http.ClientRequest;\n}\n\n/** Base Transport class implementation */\nexport abstract class BaseTransport implements Transport {\n  /** API object */\n  protected api: API;\n\n  /** The Agent used for corresponding transport */\n  public module?: HTTPRequest;\n\n  /** The Agent used for corresponding transport */\n  public client?: http.Agent | https.Agent;\n\n  /** A simple buffer holding all requests. */\n  protected readonly buffer: PromiseBuffer<SentryResponse> = new PromiseBuffer(30);\n\n  /** Create instance and set this.dsn */\n  public constructor(public options: TransportOptions) {\n    this.api = new API(options.dsn);\n  }\n\n  /** Returns a build request option object used by request */\n  protected getRequestOptions(): http.RequestOptions | https.RequestOptions {\n    const headers = {\n      ...this.api.getRequestHeaders(SDK_NAME, SDK_VERSION),\n      ...this.options.headers,\n    };\n    const dsn = this.api.getDsn();\n\n    const options: {\n      [key: string]: any;\n    } = {\n      agent: this.client,\n      headers,\n      hostname: dsn.host,\n      method: 'POST',\n      path: this.api.getStoreEndpointPath(),\n      port: dsn.port,\n      protocol: `${dsn.protocol}:`,\n    };\n\n    if (this.options.caCerts) {\n      options.ca = fs.readFileSync(this.options.caCerts);\n    }\n\n    return options;\n  }\n\n  /** JSDoc */\n  protected async sendWithModule(httpModule: HTTPRequest, body: string): Promise<SentryResponse> {\n    return this.buffer.add(\n      new Promise<SentryResponse>((resolve, reject) => {\n        const req = httpModule.request(this.getRequestOptions(), (res: http.IncomingMessage) => {\n          res.setEncoding('utf8');\n          if (res.statusCode && res.statusCode >= 200 && res.statusCode < 300) {\n            resolve({\n              status: Status.fromHttpCode(res.statusCode),\n            });\n          } else {\n            if (res.headers && res.headers['x-sentry-error']) {\n              const reason = res.headers['x-sentry-error'];\n              reject(new SentryError(`HTTP Error (${res.statusCode}): ${reason}`));\n            } else {\n              reject(new SentryError(`HTTP Error (${res.statusCode})`));\n            }\n          }\n          // force the socket to drain\n          res.on('data', () => {\n            // Drain\n          });\n          res.on('end', () => {\n            // Drain\n          });\n        });\n        req.on('error', reject);\n        req.end(body);\n      }),\n    );\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public async sendEvent(_: string): Promise<SentryResponse> {\n    throw new SentryError('Transport Class has to implement `sendEvent` method.');\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public async close(timeout?: number): Promise<boolean> {\n    return this.buffer.drain(timeout);\n  }\n}\n"]}